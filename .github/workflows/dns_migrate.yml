name: Route53 Hosted Zone Migration

on:
  workflow_dispatch:
    inputs:
      domain_name:
        description: 'Domain to migrate'
        required: true
        default: 'devopsengg.xyz'

jobs:
  migrate-dns:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install cli53
      run: |
        sudo apt update
        sudo apt install -y ruby ruby-dev
        sudo gem install cli53

    - name: Export records from old hosted zone
      id: export
      run: |
        echo "Finding hosted zone ID..."
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name --dns-name ${{ github.event.inputs.domain_name }} --query "HostedZones[0].Id" --output text | cut -d'/' -f3)
        echo "OLD_ZONE_ID=$HOSTED_ZONE_ID" >> $GITHUB_ENV

        echo "Exporting records..."
        cli53 export --full ${{ github.event.inputs.domain_name }} > records.txt
        grep -v -E 'IN[[:space:]]+(NS|SOA)' records.txt > filtered_records.txt

    - name: Create new hosted zone
      id: create
      run: |
        echo "Creating new hosted zone..."
        NEW_ZONE_JSON=$(aws route53 create-hosted-zone \
          --name ${{ github.event.inputs.domain_name }} \
          --caller-reference "$(date +%s)" \
          --output json)

        NEW_ZONE_ID=$(echo $NEW_ZONE_JSON | jq -r '.HostedZone.Id' | cut -d'/' -f3)
        echo "NEW_ZONE_ID=$NEW_ZONE_ID" >> $GITHUB_ENV
        echo "Hosted Zone created: $NEW_ZONE_ID"

    - name: Import records into new hosted zone
      run: |
        echo "Importing records..."
        cli53 import --file filtered_records.txt --replace $NEW_ZONE_ID

    - name: Output new NS records
      run: |
        echo "Fetching new NS records..."
        aws route53 get-hosted-zone --id $NEW_ZONE_ID --query 'DelegationSet.NameServers'
